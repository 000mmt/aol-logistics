<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - AOL Logistics</title>
  <link rel="stylesheet" href="dashboard.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="flex flex-col md:flex-row bg-gray-900">

  <!-- Sidebar -->
  <aside class="w-full md:w-64 bg-gray-800 shadow-md h-auto md:h-screen p-6">
    <h2 class="text-2xl font-bold text-yellow-500 mb-6">Admin</h2>
    <nav class="space-y-4">
      <a href="#" class="block font-semibold text-gray-300 hover:text-yellow-500">Dashboard</a>
      <button id="logoutBtn" class="w-full mt-6 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">Logout</button>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-4 md:p-8 overflow-y-auto">
    <h1 class="text-2xl md:text-3xl font-bold text-white mb-6">User Shipments</h1>
    <div id="userList" class="space-y-6"></div>
  </main>

<script>
const SUPABASE_URL = "https://byvffsxsfehrybkyamyu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5dmZmc3hzZmVocnlia3lhbXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNDM0MjMsImV4cCI6MjA3MzgxOTQyM30.R99A5PQ2t9keXeQdglGlq35IOGRk7d3NsqPbe9Dw8uY"; // ⚠️ Replace securely
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Session check
(async () => {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    window.location.replace("login.html");
    return;
  }
  loadUsers();
})();

// Load users with tracking
async function loadUsers() {
  const { data: users, error: userError } = await supabase
    .from("user_info")
    .select("*")
    .order("created_at", { ascending: false });

  const container = document.getElementById("userList");

  if (userError) {
    container.innerHTML = `<p class="text-red-600">Error: ${userError.message}</p>`;
    return;
  }
  if (!users.length) {
    container.innerHTML = `<p class="text-gray-400">No shipments yet.</p>`;
    return;
  }

  // Fetch tracking updates
  const userTrackingPromises = users.map(async (user) => {
    const { data: trackingUpdates } = await supabase
      .from("tracking_updates")
      .select("*")
      .eq("shipment_id", user.id)
      .order("created_at", { ascending: false })
      .limit(1);
    return { ...user, latestUpdate: trackingUpdates?.[0] || null };
  });

  const usersWithTracking = await Promise.all(userTrackingPromises);

  container.innerHTML = usersWithTracking.map(user => `
    <div class="bg-gray-800 shadow rounded-lg p-6">
      <h2 class="text-lg md:text-xl font-bold text-yellow-500 mb-2">
        ${user.receiver_name || "N/A"} 
        <span class="text-sm text-gray-300">(${user.tracking_no})</span>
      </h2>
      <p class="text-sm text-gray-400">${user.receiver_email || "N/A"} | ${user.receiver_phone || "N/A"}</p>
      <p class="text-sm text-gray-400"><b>Current Location:</b> ${user.latestUpdate?.location || 'N/A'}</p>
      <p class="text-sm text-gray-400"><b>Tracking Link:</b> <a href="${user.tracking_link}" class="text-yellow-400 break-all" target="_blank">${user.tracking_link}</a></p>
      <p class="text-sm text-gray-400"><b>Status:</b> ${user.latestUpdate?.status || "Pending"}</p>
      <div class="mt-4 flex flex-wrap gap-2">
        <button onclick="toggleTab('${user.id}','tracking')" class="px-3 py-1 bg-yellow-600 text-white rounded">Tracking</button>
        <button onclick="toggleTab('${user.id}','details')" class="px-3 py-1 bg-gray-700 text-white rounded">Details Info</button>
        <button onclick="deleteUser('${user.id}')" class="px-3 py-1 bg-red-600 text-white rounded">Delete User</button>
      </div>

      <!-- Tracking Section -->
      <div id="tracking-${user.id}" class="tab mt-4 hidden">
        <h3 class="font-semibold text-white mb-2">Shipment Tracking</h3>
        <p class="text-gray-300"><b>Tracking No:</b> ${user.tracking_no}</p>
        <p class="text-gray-300"><b>Customer:</b> ${user.receiver_name}</p>
        <p class="text-gray-300"><b>Status:</b> ${user.latestUpdate?.status || "Pending"}</p>
        <p class="text-gray-300"><b>Progress:</b> ${user.latestUpdate?.progress || "N/A"}</p>
        <p class="text-gray-300"><b>Location:</b> ${user.latestUpdate?.location || "N/A"}</p>

        <!-- Edit tracking -->
        <div class="mt-4" id="trackingForm-${user.id}">
          <h4 class="font-semibold text-white">Edit Tracking Info</h4>
          <label class="block mb-1 text-gray-400">Status</label>
          <input type="text" id="statusInput-${user.id}" value="${user.latestUpdate?.status || ""}" class="border p-2 rounded bg-gray-700 text-white w-full">

          <label class="block mb-1 text-gray-400">Progress</label>
          <select id="progressSelect-${user.id}" class="border p-2 rounded bg-gray-700 text-white w-full">
            <option ${user.latestUpdate?.progress === "Order Placed" ? "selected" : ""}>Order Placed</option>
            <option ${user.latestUpdate?.progress === "Preparing Shipment" ? "selected" : ""}>Preparing Shipment</option>
            <option ${user.latestUpdate?.progress === "Shipped" ? "selected" : ""}>Shipped</option>
            <option ${user.latestUpdate?.progress === "Delivered" ? "selected" : ""}>Delivered</option>
          </select>

          <label class="block mb-1 text-gray-400">Location</label>
          <input type="text" id="locationInput-${user.id}" value="${user.latestUpdate?.location || ""}" class="border p-2 rounded bg-gray-700 text-white w-full">

          <label class="block mb-1 text-gray-400">Note</label>
          <textarea id="noteInput-${user.id}" class="border p-2 rounded bg-gray-700 text-white w-full">${user.latestUpdate?.note || ""}</textarea>

          <button onclick="saveTrackingUpdate('${user.id}')" class="mt-2 bg-yellow-500 text-white px-4 py-2 rounded w-full">Save Tracking Info</button>
        </div>
      </div>

      <!-- Details Section -->
      <div id="details-${user.id}" class="tab mt-4 hidden">
        <h3 class="font-semibold text-white mb-2">Receiver, Customer & Shipment Details</h3>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <label class="block text-gray-400">Receiver Name
            <input type="text" value="${user.receiver_name || ''}" onchange="updateUser('${user.id}', { receiver_name: this.value })" class="w-full p-2 rounded bg-gray-700 text-white">
          </label>
          <label class="block text-gray-400">Receiver Email
            <input type="text" value="${user.receiver_email || ''}" onchange="updateUser('${user.id}', { receiver_email: this.value })" class="w-full p-2 rounded bg-gray-700 text-white">
          </label>
          <label class="block text-gray-400">Receiver Phone
            <input type="text" value="${user.receiver_phone || ''}" onchange="updateUser('${user.id}', { receiver_phone: this.value })" class="w-full p-2 rounded bg-gray-700 text-white">
          </label>
          <label class="block text-gray-400">Receiver Address
            <input type="text" value="${user.receiver_address || ''}" onchange="updateUser('${user.id}', { receiver_address: this.value })" class="w-full p-2 rounded bg-gray-700 text-white">
          </label>
          <label class="block text-gray-400">Receiver Country
            <input type="text" value="${user.receiver_country || ''}" onchange="updateUser('${user.id}', { receiver_country: this.value })" class="w-full p-2 rounded bg-gray-700 text-white">
          </label>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <label class="block text-gray-400">Customer Name
            <input type="text" value="${user.customer_name || ''}" onchange="updateUser('${user.id}', { customer_name: this.value })" class="w-full p-2 rounded bg-gray-700 text-white">
          </label>
          <label class="block text-gray-400">Customer Email
            <input type="text" value="${user.email || ''}" onchange="updateUser('${user.id}', { email: this.value })" class="w-full p-2 rounded bg-gray-700 text-white">
          </label>
          <label class="block text-gray-400">Customer Phone
            <input type="text" value="${user.phone || ''}" onchange="updateUser('${user.id}', { phone: this.value })" class="w-full p-2 rounded bg-gray-700 text-white">
          </label>
          <label class="block text-gray-400">Origin
            <input type="text" value="${user.origin || ''}" onchange="updateUser('${user.id}', { origin: this.value })" class="w-full p-2 rounded bg-gray-700 text-white">
          </label>
          <label class="block text-gray-400">Destination
            <input type="text" value="${user.destination || ''}" onchange="updateUser('${user.id}', { destination: this.value })" class="w-full p-2 rounded bg-gray-700 text-white">
          </label>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <label class="block text-gray-400">ASALU No
            <input type="text" value="${user.asalu_no || ''}" onchange="updateUser('${user.id}', { asalu_no: this.value })" class="w-full p-2 rounded bg-gray-700 text-white">
          </label>
          <label class="block text-gray-400">Delivery Code
            <input type="text" value="${user.delivery_code || ''}" onchange="updateUser('${user.id}', { delivery_code: this.value })" class="w-full p-2 rounded bg-gray-700 text-white">
          </label>
          <label class="block text-gray-400">Item No
            <input type="text" value="${user.item_no || ''}" onchange="updateUser('${user.id}', { item_no: this.value })" class="w-full p-2 rounded bg-gray-700 text-white">
          </label>
        </div>
        
        <button onclick="updateUser('${user.id}')" class="mt-2 bg-yellow-500 text-white px-4 py-2 rounded w-full">Save Details</button>
      </div>
    </div>
  `).join("");
}

// Delete user
async function deleteUser(userId) {
  const { error } = await supabase.from("user_info").delete().eq("id", userId);
  if (error) {
    alert("Error deleting user: " + error.message);
  } else {
    loadUsers();
  }
}

// Save tracking update
async function saveTrackingUpdate(userId) {
  const progress = document.querySelector(`#progressSelect-${userId}`).value;
  const status = document.querySelector(`#statusInput-${userId}`).value;
  const location = document.querySelector(`#locationInput-${userId}`).value;
  const note = document.querySelector(`#noteInput-${userId}`).value;

  const { data: userInfo } = await supabase
    .from("user_info")
    .select("tracking_no")
    .eq("id", userId)
    .single();

  await supabase.from("tracking_updates").insert([{
    shipment_id: userId,
    tracking_no: userInfo.tracking_no,
    status,
    progress,
    location,
    note
  }]);

  loadUsers();
}

// Update user
async function updateUser(id, updates = {}) {
  await supabase.from("user_info").update(updates).eq("id", id);
  loadUsers();
}

// Tab toggle function
function toggleTab(userId, tab) {
  document.querySelectorAll(`#tracking-${userId}, #details-${userId}`).forEach(el => el.classList.add("hidden"));
  document.getElementById(`${tab}-${userId}`).classList.remove("hidden");
}

// Logout
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await supabase.auth.signOut();
  window.location.href = "login.html";
});
</script>
</body>
</html>
