<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - AOL Logistics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="flex bg-gray-100">
  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-md h-screen p-6">
    <h2 class="text-2xl font-bold text-yellow-500 mb-6">Admin</h2>
    <nav class="space-y-4">
      <a href="#" class="block font-semibold hover:text-yellow-500">Shipments</a>
      <button id="logoutBtn" class="w-full mt-6 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">Logout</button>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8">
    <h1 class="text-3xl font-bold mb-6">All Shipments</h1>
    <div class="overflow-x-auto bg-white shadow-lg rounded-lg">
      <table class="min-w-full table-auto text-left">
        <thead class="bg-yellow-500 text-white">
          <tr>
            <th class="p-3">Shipment No</th>
            <th class="p-3">Customer</th>
            <th class="p-3">Email</th>
            <th class="p-3">Phone</th>
            <th class="p-3">Origin</th>
            <th class="p-3">Destination</th>
            <th class="p-3">Weight</th>
            <th class="p-3">Description</th>
            <th class="p-3">Status</th>
            <th class="p-3">Actions</th>
          </tr>
        </thead>
        <tbody id="shipmentTable"></tbody>
      </table>
    </div>
  </main>

  <script>
    const supabase = window.supabase.createClient("https://byvffsxsfehrybkyamyu.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5dmZmc3hzZmVocnlia3lhbXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNDM0MjMsImV4cCI6MjA3MzgxOTQyM30.R99A5PQ2t9keXeQdglGlq35IOGRk7d3NsqPbe9Dw8uY"); // Use environment variables in production

    // Load shipments
    async function loadShipments() {
      const table = document.getElementById("shipmentTable");
      table.innerHTML = `<tr><td colspan="10" class="text-center p-3">Loading...</td></tr>`;

      const { data, error } = await supabase.from("shipments").select("*").order("created_at", { ascending: false });

      if (error) {
        table.innerHTML = `<tr><td colspan="10" class="text-red-600 text-center p-3">Error loading shipments: ${error.message}</td></tr>`;
        return;
      }

      table.innerHTML = data.map(shipment => `
        <tr class="border-b">
          <td class="p-3">${shipment.shipment_no}</td>
          <td class="p-3">${shipment.customer_name}</td>
          <td class="p-3">${shipment.email}</td>
          <td class="p-3">${shipment.phone || 'N/A'}</td>
          <td class="p-3">${shipment.origin}</td>
          <td class="p-3">${shipment.destination}</td>
          <td class="p-3">${shipment.weight || 'N/A'} kg</td>
          <td class="p-3">${shipment.description || 'N/A'}</td>
          <td class="p-3">
            <select onchange="updateStatus('${shipment.id}', this.value)" class="border p-2 rounded">
              <option value="Pending" ${shipment.status === "Pending" ? "selected" : ""}>Pending</option>
              <option value="In Transit" ${shipment.status === "In Transit" ? "selected" : ""}>In Transit</option>
              <option value="Delivered" ${shipment.status === "Delivered" ? "selected" : ""}>Delivered</option>
            </select>
          </td>
          <td class="p-3 flex gap-2">
            <button onclick='printReceipt(${JSON.stringify(shipment)})' class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Print</button>
            <button onclick='downloadPDF(${JSON.stringify(shipment)})' class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">PDF</button>
          </td>
        </tr>
      `).join('') || `<tr><td colspan="10" class="text-center p-3">No shipments found.</td></tr>`;
    }

    // Update shipment status
    async function updateStatus(id, status) {
      await supabase.from("shipments").update({ status }).eq("id", id);
      loadShipments();
    }

    // Print receipt
    function printReceipt(data) {
      const receiptWindow = window.open("", "_blank");
      receiptWindow.document.write(`
        <html>
          <head>
            <title>Shipment Receipt</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h2 { color: #f59e0b; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              td { padding: 8px; border: 1px solid #ddd; }
            </style>
          </head>
          <body>
            <h2>AOL LOGISTICS - Shipment Receipt</h2>
            <table>
              <tr><td><b>Shipment No:</b></td><td>${data.shipment_no}</td></tr>
              <tr><td><b>Customer:</b></td><td>${data.customer_name}</td></tr>
              <tr><td><b>Email:</b></td><td>${data.email}</td></tr>
              <tr><td><b>Phone:</b></td><td>${data.phone || 'N/A'}</td></tr>
              <tr><td><b>Origin:</b></td><td>${data.origin}</td></tr>
              <tr><td><b>Destination:</b></td><td>${data.destination}</td></tr>
              <tr><td><b>Weight:</b></td><td>${data.weight || 'N/A'} kg</td></tr>
              <tr><td><b>Description:</b></td><td>${data.description || 'N/A'}</td></tr>
              <tr><td><b>Status:</b></td><td>${data.status}</td></tr>
              <tr><td><b>Date:</b></td><td>${new Date(data.created_at).toLocaleString()}</td></tr>
            </table>
            <script>window.print();</script>
          </body>
        </html>
      `);
      receiptWindow.document.close();
    }

    // Download PDF receipt
    async function downloadPDF(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.setTextColor(245, 158, 11);
      doc.text("AOL LOGISTICS - Shipment Receipt", 20, 20);
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      const details = [
        ["Shipment No", data.shipment_no],
        ["Customer", data.customer_name],
        ["Email", data.email],
        ["Phone", data.phone || "N/A"],
        ["Origin", data.origin],
        ["Destination", data.destination],
        ["Weight", `${data.weight || "N/A"} kg`],
        ["Description", data.description || "N/A"],
        ["Status", data.status],
        ["Date", new Date(data.created_at).toLocaleString()],
      ];
      let y = 40;
      details.forEach(([label, value]) => {
        doc.text(`${label}:`, 20, y);
        doc.text(String(value), 80, y);
        y += 10;
      });
      doc.save(`Shipment_${data.shipment_no}.pdf`);
    }

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    loadShipments();
  </script>
</body>
</html>
