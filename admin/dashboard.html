<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - AOL Logistics</title>
  <link rel="stylesheet" href="dashboard.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <aside>
    <h2>Admin</h2>
    <nav>
      <a href="#">Shipments</a>
      <button id="logoutBtn">Logout</button>
    </nav>
  </aside>

  <!-- Main Content -->
  <main>
    <h1>All Shipments</h1>
    <div class="overflow-x-auto">
      <table>
        <thead>
          <tr>
            <th>Shipment No</th>
            <th>Customer</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Origin</th>
            <th>Destination</th>
            <th>Weight</th>
            <th>Description</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="shipmentTable"></tbody>
      </table>
    </div>
  </main>

  <script>
    const supabase = window.supabase.createClient("https://your-supabase-url", "your-supabase-key");

    // --- Check Authentication ---
    async function checkAuth() {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = "login.html";
      } else {
        applyUserSettings(user.email);
      }
    }

    // --- Apply user-specific settings ---
    async function applyUserSettings(email) {
      const { data, error } = await supabase.from("admin_settings").select("*").eq("email", email).single();

      if (data && data.theme) {
        document.body.setAttribute("data-theme", data.theme);
      }
    }

    // --- Load Shipments ---
    async function loadShipments() {
      const table = document.getElementById("shipmentTable");
      table.innerHTML = `<tr><td colspan="10" style="text-align:center;">Loading...</td></tr>`;

      const { data, error } = await supabase.from("shipments").select("*").order("created_at", { ascending: false });

      if (error) {
        table.innerHTML = `<tr><td colspan="10" style="text-align:center;color:red;">Error: ${error.message}</td></tr>`;
        return;
      }

      table.innerHTML = data.map(shipment => `
        <tr>
          <td>${shipment.shipment_no}</td>
          <td>${shipment.customer_name}</td>
          <td>${shipment.email}</td>
          <td>${shipment.phone || 'N/A'}</td>
          <td>${shipment.origin}</td>
          <td>${shipment.destination}</td>
          <td>${shipment.weight || 'N/A'} kg</td>
          <td>${shipment.description || 'N/A'}</td>
          <td>
            <select onchange="updateStatus('${shipment.id}', this.value)">
              <option value="Pending" ${shipment.status === "Pending" ? "selected" : ""}>Pending</option>
              <option value="In Transit" ${shipment.status === "In Transit" ? "selected" : ""}>In Transit</option>
              <option value="Delivered" ${shipment.status === "Delivered" ? "selected" : ""}>Delivered</option>
            </select>
          </td>
          <td>
            <button onclick='openReceipt(${JSON.stringify(shipment)})' class="bg-blue-500 text-white px-3 py-1">Print</button>
            <button onclick='downloadPDF(${JSON.stringify(shipment)})' class="bg-green-500 text-white px-3 py-1">PDF</button>
          </td>
        </tr>
      `).join('') || `<tr><td colspan="10" style="text-align:center;">No shipments found.</td></tr>`;
    }

    // --- Update status ---
    async function updateStatus(id, status) {
      await supabase.from("shipments").update({ status }).eq("id", id);
      loadShipments();
    }

    // --- Open Receipt Page ---
    function openReceipt(data) {
      const encoded = encodeURIComponent(JSON.stringify(data));
      window.open(`receipt.html?data=${encoded}`, "_blank");
    }

    // --- Download PDF ---
    async function downloadPDF(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16).setTextColor(245, 158, 11);
      doc.text("AOL LOGISTICS - Shipment Receipt", 20, 20);
      doc.setFontSize(12).setTextColor(0, 0, 0);

      const details = [
        ["Shipment No", data.shipment_no],
        ["Customer", data.customer_name],
        ["Email", data.email],
        ["Phone", data.phone || "N/A"],
        ["Origin", data.origin],
        ["Destination", data.destination],
        ["Weight", `${data.weight || "N/A"} kg`],
        ["Description", data.description || "N/A"],
        ["Status", data.status],
        ["Date", new Date(data.created_at).toLocaleString()],
      ];

      let y = 40;
      details.forEach(([label, value]) => {
        doc.text(`${label}:`, 20, y);
        doc.text(String(value), 80, y);
        y += 10;
      });
      doc.save(`Shipment_${data.shipment_no}.pdf`);
    }

    // --- Logout ---
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    // Init
    checkAuth().then(loadShipments);
  </script>
</body>
</html>
