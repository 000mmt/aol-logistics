<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - AOL Logistics</title>
  <link rel="stylesheet" href="dashboard.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="flex bg-gray-100">
  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-md h-screen p-6">
    <h2 class="text-2xl font-bold text-yellow-500 mb-6">Admin</h2>
    <nav class="space-y-4">
      <a href="#" class="block font-semibold hover:text-yellow-500">Dashboard</a>
      <button id="logoutBtn" class="w-full mt-6 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">Logout</button>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-8">
    <h1 class="text-3xl font-bold mb-6">User Shipments</h1>

    <div id="userList" class="space-y-6"></div>
  </main>

  <script>
    const SUPABASE_URL = "https://byvffsxsfehrybkyamyu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5dmZmc3hzZmVocnlia3lhbXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNDM0MjMsImV4cCI6MjA3MzgxOTQyM30.R99A5PQ2t9keXeQdglGlq35IOGRk7d3NsqPbe9Dw8uY"; // ⚠️ use anon/public for client, service role only in backend
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Load users
    async function loadUsers() {
      const { data, error } = await supabase
        .from("user_info")
        .select("*")
        .order("created_at", { ascending: false });

      const container = document.getElementById("userList");
      if (error) {
        container.innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
        return;
      }

      if (!data.length) {
        container.innerHTML = `<p class="text-gray-600">No shipments yet.</p>`;
        return;
      }

      container.innerHTML = data.map(user => `
        <div class="bg-white shadow rounded-lg p-6">
          <h2 class="text-xl font-bold mb-2">${user.customer_name} 
            <span class="text-sm text-gray-500">(${user.tracking_no})</span>
          </h2>
          <p class="text-sm text-gray-600">${user.email} | ${user.phone || "N/A"}</p>

          <!-- Tabs -->
          <div class="mt-4">
            <button onclick="toggleTab('${user.id}','tracking')" class="px-3 py-1 bg-yellow-500 text-white rounded">Tracking</button>
            <button onclick="toggleTab('${user.id}','details')" class="px-3 py-1 bg-gray-300 rounded">Details Info</button>
          </div>

          <!-- Tracking Section -->
          <div id="tracking-${user.id}" class="tab mt-4 hidden">
            <h3 class="font-semibold mb-2">Shipment Tracking</h3>
            <p><b>Tracking No:</b> ${user.tracking_no}</p>
            <p><b>Tracking Link:</b> <a href="${user.tracking_link}" class="text-blue-500" target="_blank">${user.tracking_link}</a></p>
            <p><b>Customer:</b> ${user.customer_name}</p>
            <p><b>Origin:</b> ${user.origin || 'N/A'}</p>
            <p><b>Destination:</b> ${user.destination || 'N/A'}</p>
            <p><b>Status:</b> ${user.status || "Pending"}</p>

            <!-- Editable Form -->
            <div class="mt-4">
              <h4 class="font-semibold">Edit Tracking Info</h4>
              <label class="block mb-1">Progress</label>
              <select onchange="updateUser('${user.id}', { progress: this.value })" class="border p-2 rounded">
                <option value="Order Placed" ${user.progress === "Order Placed" ? "selected" : ""}>Order Placed</option>
                <option value="Preparing Shipment" ${user.progress === "Preparing Shipment" ? "selected" : ""}>Preparing Shipment</option>
                <option value="Shipped" ${user.progress === "Shipped" ? "selected" : ""}>Shipped</option>
                <option value="Delivered" ${user.progress === "Delivered" ? "selected" : ""}>Delivered</option>
              </select>
              <button onclick="updateUser('${user.id}', { status: 'Updated' })" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Save Tracking Info</button>
            </div>
          </div>

          <!-- Details Info Section -->
          <div id="details-${user.id}" class="tab mt-4 hidden">
            <h3 class="font-semibold mb-2">Details Info</h3>
            <p><b>Origin:</b> ${user.origin || 'N/A'}</p>
            <p><b>Destination:</b> ${user.destination || 'N/A'}</p>
            <p><b>Weight:</b> ${user.weight || 'N/A'}</p>
            <p><b>Description:</b> ${user.description || 'N/A'}</p>
            <p><b>Registration Fee:</b> ${user.registration_fee || 'N/A'}</p>
            <p><b>Delivery Fee:</b> ${user.delivery_fee || 'N/A'}</p>
            <p><b>Insurance Fee:</b> ${user.insurance_fee || 'N/A'}</p>

            <!-- Editable Form -->
            <div class="mt-4">
              <h4 class="font-semibold">Edit Details Info</h4>
              <label>Origin
                <input type="text" value="${user.origin || ''}" onchange="updateUser('${user.id}', { origin: this.value })" class="border p-2 w-full rounded">
              </label>
              <label>Destination
                <input type="text" value="${user.destination || ''}" onchange="updateUser('${user.id}', { destination: this.value })" class="border p-2 w-full rounded">
              </label>
              <label>Weight
                <input type="number" value="${user.weight || ''}" onchange="updateUser('${user.id}', { weight: this.value })" class="border p-2 w-full rounded">
              </label>
              <label>Description
                <input type="text" value="${user.description || ''}" onchange="updateUser('${user.id}', { description: this.value })" class="border p-2 w-full rounded">
              </label>
              <label>Registration Fee
                <input type="number" value="${user.registration_fee || ''}" onchange="updateUser('${user.id}', { registration_fee: this.value })" class="border p-2 w-full rounded">
              </label>
              <label>Delivery Fee
                <input type="number" value="${user.delivery_fee || ''}" onchange="updateUser('${user.id}', { delivery_fee: this.value })" class="border p-2 w-full rounded">
              </label>
              <label>Insurance Fee
                <input type="number" value="${user.insurance_fee || ''}" onchange="updateUser('${user.id}', { insurance_fee: this.value })" class="border p-2 w-full rounded">
              </label>
              <button onclick="updateUser('${user.id}')" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Save Details Info</button>
            </div>
          </div>
        </div>
      `).join("");
    }

    // Update user
    async function updateUser(id, updates = {}) {
      const { error } = await supabase.from("user_info").update(updates).eq("id", id);
      if (error) alert("Error updating: " + error.message);
      else loadUsers(); // Reload users to reflect changes
    }

    // Delete user
    async function deleteUser(id) {
      if (!confirm("Delete this user?")) return;
      const { error } = await supabase.from("user_info").delete().eq("id", id);
      if (error) alert("Error deleting: " + error.message);
      else loadUsers();
    }

    // Print receipt
    function printReceipt(id) {
      window.open(`receipt.html?id=${id}`, "_blank");
    }

    // Tab toggle
    function toggleTab(userId, tab) {
      document.querySelectorAll(`#tracking-${userId}, #details-${userId}`).forEach(el => el.classList.add("hidden"));
      document.getElementById(`${tab}-${userId}`).classList.remove("hidden");
    }

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    loadUsers();
  </script>
</body>
</html>
