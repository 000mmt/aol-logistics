<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>배송 추적 - AOL 물류</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    /* icons size */
    .progress-icon {
      width: 50px;
      height: 50px;
    }

    /* mobile menu collapse animation (use max-height to animate) */
    #mobileMenu.mobile-menu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 300ms ease, opacity 250ms ease;
      opacity: 0;
    }
    #mobileMenu.mobile-menu.open {
      max-height: 420px; /* enough to show links */
      opacity: 1;
    }

    /* ensure progress line sits above base line visually */
    #progressLine {
      height: 4px;
    }

    /* responsive tweaks to make progress steps wrap on small screens */
    .progress-step {
      width: 50%;
    }
    @media (min-width: 640px) {
      .progress-step {
        width: auto;
      }
    }

    /* Map styling and spacing to prevent it from hugging the details */
    #map {
      height: 420px;
      width: 100%;
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 0 6px 20px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    }

    /* small helper for timeline items */
    .timeline-item { padding-left: 0.75rem; border-left-width: 2px; border-left-color: rgba(14,165,233,0.85); }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

  <!-- Header/Navbar -->
  <header class="bg-gray-800 shadow-md sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center px-4 md:px-6 py-3">
      <!-- Logo -->
      <a href="home.html" class="flex items-center space-x-3">
        <img src="images/images (2).jpeg" alt="Logo" class="h-12 w-12 object-cover rounded-full">
        <div class="flex flex-col leading-tight min-w-0">
          <h1 class="text-lg md:text-xl font-bold text-sky-400 italic truncate" data-key="brand">
            AOL LOGISTICS
          </h1>
          <p class="text-xs italic text-gray-300 -mt-1 tracking-tight truncate hidden sm:block">
            delivery service at its finest
          </p>
        </div>
      </a>

      <!-- Desktop Nav -->
      <nav class="hidden md:flex space-x-6 text-gray-200 font-medium items-center">
        <a href="home.html" class="hover:text-sky-400" data-key="nav_home">Home</a>
        <a href="tracking-form.html" class="hover:text-sky-400" data-key="nav_tracking">Tracking</a>
      </nav>

      <!-- Right Side -->
      <div class="flex items-center space-x-3">
        <button id="toggleLang" aria-pressed="false" class="px-3 py-1 text-sm bg-sky-500 text-white rounded-md hover:bg-sky-600">
          English
        </button>

        <!-- mobile menu button -->
        <button id="menuBtn" class="md:hidden focus:outline-none" aria-controls="mobileMenu" aria-expanded="false">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor"
               viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round"
                  stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu (animated overlay under header) -->
    <div id="mobileMenu" class="mobile-menu md:hidden absolute top-full left-0 right-0 bg-gray-700 z-40">
      <nav class="flex flex-col space-y-2 p-4">
        <a href="home.html" class="block text-gray-200 hover:text-sky-400" data-key="nav_home_mobile">Home</a>
        <a href="tracking-form.html" class="block text-gray-200 hover:text-sky-400" data-key="nav_tracking_mobile">Tracking</a>
      </nav>
    </div>
  </header>

  <!-- Container -->
  <main class="flex-1 container mx-auto px-4 md:px-6 py-8 md:py-10">

    <!-- Shipment Summary -->
    <div id="shipmentSummary" class="bg-gray-800 shadow-lg rounded-xl p-6 mb-4 hidden">
      <h3 class="text-xl font-semibold mb-4 text-sky-400" data-key="shipmentDetails">배송 세부 정보</h3>
      <div class="grid md:grid-cols-2 gap-4 text-sm">
        <p><strong data-key="trackingNo">운송장 번호:</strong> <span id="summaryTrackingNo"></span></p>
        <p><strong data-key="customer">고객:</strong> <span id="summaryCustomer"></span></p>
        <p><strong data-key="origin">출발지:</strong> <span id="summaryOrigin"></span></p>
        <p><strong data-key="destination">도착지:</strong> <span id="summaryDestination"></span></p>
        <p><strong data-key="status">상태:</strong> <span id="summaryStatus" class="font-semibold text-sky-400"></span></p>
        <p><strong data-key="location">현재 위치:</strong> <span id="summaryLocation" class="font-semibold text-gray-300"></span></p>
      </div>
    </div>

    <!-- Map: placed after shipment details and before progress -->
    <div id="map" class="hidden" aria-hidden="true"></div>

   <!-- Progress Bar -->
   <div id="progressSection" class="mb-8 hidden">
     <h3 class="text-xl font-semibold mb-4 text-sky-400" data-key="shipmentProgress">배송 진행 상황</h3>

     <div class="relative flex items-center justify-between">
       <!-- Base line (gray) -->
       <div class="absolute top-1/2 inset-x-0 mx-auto h-1 bg-gray-600 -z-10 rounded w-full max-w-[90%]"></div>

       <!-- Load (sky-blue) line -->
       <div id="progressLine" class="absolute top-1/2 left-0 h-1 bg-sky-500 -z-10 rounded transition-all duration-500" style="width:0%;"></div>

       <!-- Steps -->
       <div id="stepPending" class="flex flex-col items-center relative z-10 w-1/4">
         <img src="https://cdn-icons-png.flaticon.com/512/861/861060.png" alt="Pending" class="progress-icon opacity-50">
         <p class="mt-2 text-sm" data-key="orderPlaced">주문 접수</p>
       </div>

       <div id="stepTransit" class="flex flex-col items-center relative z-10 w-1/4">
         <img src="https://cdn-icons-png.flaticon.com/512/263/263142.png" alt="Preparing Shipment" class="progress-icon opacity-50">
         <p class="mt-2 text-sm" data-key="preparing">준비 중</p>
       </div>

       <div id="stepShipped" class="flex flex-col items-center relative z-10 w-1/4">
         <img src="https://cdn-icons-png.flaticon.com/512/1995/1995560.png" alt="Shipped" class="progress-icon opacity-50">
         <p class="mt-2 text-sm" data-key="shipped">배송 중</p>
       </div>

       <div id="stepDelivered" class="flex flex-col items-center relative z-10 w-1/4">
         <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" alt="Delivered" class="progress-icon opacity-50">
         <p class="mt-2 text-sm" data-key="delivered">배송 완료</p>
       </div>
     </div>
   </div>

    <!-- Timeline -->
    <div id="updatesTimeline" class="bg-gray-800 shadow-lg rounded-xl p-6 hidden">
      <h3 class="text-xl font-semibold mb-6 text-sky-400" data-key="trackingUpdates">배송 업데이트</h3>
      <div id="timeline" class="relative border-l border-gray-600 pl-6 space-y-6"></div>
    </div>

    <!-- Loading / Message -->
    <div id="message" class="text-center text-gray-400 mt-6"></div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white text-center py-4">
    <p>&copy; 2025 AOL 물류. 모든 권리 보유.</p>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
  /***** CONFIG (replace with your real values if needed) *****/
  const SUPABASE_URL = "https://byvffsxsfehrybkyamyu.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5dmZmc3hzZmVocnlia3lhbXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNDM0MjMsImV4cCI6MjA3MzgxOTQyM30.R99A5PQ2t9keXeQdglGlq35IOGRk7d3NsqPbe9Dw8uY"; // <-- replace if you prefer a different key

  /***** INIT supabase client *****/
  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

  /***** DOM refs *****/
  const menuBtn = document.getElementById("menuBtn");
  const mobileMenu = document.getElementById("mobileMenu");
  const toggleLangBtn = document.getElementById("toggleLang");

  const params = new URLSearchParams(window.location.search);
  const trackingNo = params.get("tracking_no");

  const summaryEl = document.getElementById("shipmentSummary");
  const updatesEl = document.getElementById("updatesTimeline");
  const progressEl = document.getElementById("progressSection");
  const timelineEl = document.getElementById("timeline");
  const messageEl = document.getElementById("message");
  const progressLine = document.getElementById("progressLine");
  const mapEl = document.getElementById("map");

  /***** Translations (keys used as data-key in the page) *****/
  const translations = {
    ko: {
      brand: "AOL LOGISTICS",
      nav_home: "홈",
      nav_tracking: "배송 추적",
      nav_home_mobile: "홈",
      nav_tracking_mobile: "배송 추적",
      shipmentDetails: "배송 세부 정보",
      trackingNo: "운송장 번호:",
      customer: "고객:",
      origin: "출발지:",
      destination: "도착지:",
      status: "상태:",
      location: "현재 위치:",
      shipmentProgress: "배송 진행 상황",
      orderPlaced: "주문 접수",
      preparing: "준비 중",
      shipped: "배송 중",
      delivered: "배송 완료",
      trackingUpdates: "배송 업데이트",
      loadingShipment: "배송 정보를 불러오는 중...",
      invalidCodeMessage: "유효하지 않은 운송장 코드입니다.",
      notAvailable: "사용 불가",
      unknown: "알 수 없음",
      step_order: "주문 접수",
      step_prep: "준비 중",
      step_shipped: "배송 중",
      step_delivered: "배송 완료"
    },
    en: {
      brand: "AOL LOGISTICS",
      nav_home: "Home",
      nav_tracking: "Track Shipment",
      nav_home_mobile: "Home",
      nav_tracking_mobile: "Track Shipment",
      shipmentDetails: "Shipment Details",
      trackingNo: "Tracking No:",
      customer: "Customer:",
      origin: "Origin:",
      destination: "Destination:",
      status: "Status:",
      location: "Current Location:",
      shipmentProgress: "Shipment Progress",
      orderPlaced: "Order Placed",
      preparing: "Preparing Shipment",
      shipped: "Shipped",
      delivered: "Delivered",
      trackingUpdates: "Tracking Updates",
      loadingShipment: "Loading shipment...",
      invalidCodeMessage: "Invalid tracking code.",
      notAvailable: "Not available",
      unknown: "Unknown",
      step_order: "Order Placed",
      step_prep: "Preparing Shipment",
      step_shipped: "Shipped",
      step_delivered: "Delivered"
    }
  };

  /***** status mapping helpers *****/
  const statusMapping = {
    "Order Placed": { key: "orderPlaced", stepId: "stepPending" },
    "Preparing Shipment": { key: "preparing", stepId: "stepTransit" },
    "Shipped": { key: "shipped", stepId: "stepShipped" },
    "Delivered": { key: "delivered", stepId: "stepDelivered" }
  };
  const orderStatuses = Object.keys(statusMapping); // ['Order Placed','Preparing Shipment','Shipped','Delivered']

  // normalize different language / variations into the canonical English keys above
  function normalizeProgress(raw) {
    if (!raw) return "Order Placed";
    const trimmed = String(raw).trim();

    // direct matches (English)
    if (orderStatuses.includes(trimmed)) return trimmed;

    // Korean matches
    const koMap = {
      "주문 접수": "Order Placed",
      "접수": "Order Placed",
      "준비 중": "Preparing Shipment",
      "준비": "Preparing Shipment",
      "배송 중": "Shipped",
      "배송": "Shipped",
      "배송 완료": "Delivered",
      "완료": "Delivered"
    };
    if (koMap[trimmed]) return koMap[trimmed];

    // fuzzy checks
    const lower = trimmed.toLowerCase();
    if (lower.includes("order") || lower.includes("placed") || lower.includes("접수")) return "Order Placed";
    if (lower.includes("prepare") || lower.includes("preparing") || lower.includes("준비")) return "Preparing Shipment";
    if (lower.includes("ship") && !lower.includes("deliver")) return "Shipped";
    if (lower.includes("deliver") || lower.includes("완료")) return "Delivered";

    return "Order Placed";
  }

  /***** language state and rendering *****/
  let currentLang = localStorage.getItem('site_lang') || 'ko';

  function setLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('site_lang', lang);

    // set static text from data-key attributes
    document.querySelectorAll('[data-key]').forEach(el => {
      const key = el.getAttribute('data-key');
      if (!key) return;
      // If translations don't have that key, don't override
      if (translations[lang] && translations[lang][key]) {
        el.textContent = translations[lang][key];
      }
    });

    // toggle language button label shows the *other* language
    toggleLangBtn.textContent = (lang === 'ko') ? 'English' : '한국어';
    toggleLangBtn.setAttribute('aria-pressed', String(lang === 'en'));

    // re-render dynamic content in the chosen language
    renderDynamicContent();
  }

  // store fetched data to allow re-render when language changes
  let fetchedShipment = null;
  let fetchedUpdates = [];

  function renderDynamicContent() {
    // message text (loading) if present
    if (messageEl.dataset.loading === "true") {
      messageEl.textContent = translations[currentLang].loadingShipment || "Loading...";
    }

    if (!fetchedShipment) return;

    // summary fields
    document.getElementById("summaryTrackingNo").textContent = fetchedShipment.tracking_no || "-";
    document.getElementById("summaryCustomer").textContent = fetchedShipment.receiver_name || "-";
    document.getElementById("summaryOrigin").textContent = fetchedShipment.origin || "-";
    // prefer receiver_country or destination
    document.getElementById("summaryDestination").textContent = fetchedShipment.receiver_country || fetchedShipment.destination || "-";

    // latest update (first)
    const latest = (fetchedUpdates && fetchedUpdates.length) ? fetchedUpdates[0] : null;
    const normalized = normalizeProgress(latest?.progress || fetchedShipment.status || "Order Placed");
    const statusKey = statusMapping[normalized]?.key || 'orderPlaced';
    const localizedStatus = translations[currentLang][statusKey] || normalized;
    document.getElementById("summaryStatus").textContent = localizedStatus;
    document.getElementById("summaryLocation").textContent = (latest?.location || fetchedShipment.location_text || fetchedShipment.location || translations[currentLang].notAvailable || "Not available");

    // progress visuals
    highlightStep(normalized);

    // timeline rendering (from updates array)
    if (fetchedUpdates && fetchedUpdates.length) {
      updatesEl.classList.remove("hidden");
      timelineEl.innerHTML = fetchedUpdates.map(update => {
        const norm = normalizeProgress(update.progress);
        const statusKey2 = statusMapping[norm]?.key || 'orderPlaced';
        const displayStatus = translations[currentLang][statusKey2] || norm;
        const displayLocation = update.location || translations[currentLang].unknown || "Unknown";
        const timeStr = update.created_at ? new Date(update.created_at).toLocaleString() : "";
        const noteHtml = update.note ? `<p class="mt-1 text-gray-400 italic">${escapeHtml(update.note)}</p>` : "";
        return `
          <div class="relative">
            <div class="absolute -left-3 top-1 w-6 h-6 rounded-full bg-sky-500 border-2 border-gray-900"></div>
            <div class="ml-4">
              <p class="font-semibold text-sky-400">${escapeHtml(displayStatus)}</p>
              <p class="text-gray-300">${escapeHtml(displayLocation)}</p>
              <p class="text-sm text-gray-400">${escapeHtml(timeStr)}</p>
              ${noteHtml}
            </div>
          </div>
        `;
      }).join("");
    } else {
      timelineEl.innerHTML = `<p class="text-gray-400">${translations[currentLang].notAvailable}</p>`;
    }

    applyTranslations(currentLang);
  }

  /***** toggle mobile menu with animation (open/close) *****/
  let menuOpen = false;
  menuBtn.addEventListener('click', () => {
    menuOpen = !menuOpen;
    if (menuOpen) {
      mobileMenu.classList.add('open');
      mobileMenu.classList.remove('hidden');
    } else {
      mobileMenu.classList.remove('open');
    }
    menuBtn.setAttribute('aria-expanded', String(menuOpen));
  });

  /***** language toggle button *****/
  toggleLangBtn.addEventListener('click', () => {
    const next = (currentLang === 'ko') ? 'en' : 'ko';
    setLanguage(next);
  });

  // initial language set
  setLanguage(currentLang);

  /***** Sanitizer helper *****/
  function escapeHtml(str = "") {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

  /***** Map-related logic *****/
  let mapInstance = null;
  let mapMarker = null;
  async function updateMapTo(lat, lng, popupText = "") {
    if (!lat || !lng) return;
    if (!mapInstance) {
      mapInstance = L.map('map', { zoomControl: true, attributionControl: true }).setView([lat, lng], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(mapInstance);
      mapMarker = L.marker([lat, lng]).addTo(mapInstance).bindPopup(popupText || '');
      mapEl.classList.remove('hidden');
    } else {
      mapInstance.setView([lat, lng], mapInstance.getZoom() || 11);
      if (mapMarker) {
        mapMarker.setLatLng([lat, lng]).setPopupContent(popupText || '');
      } else {
        mapMarker = L.marker([lat, lng]).addTo(mapInstance).bindPopup(popupText || '');
      }
    }
  }

  // Try to derive coordinates from record or update and fallback to geocoding if only text location present
  async function deriveCoordinates(shipment, latestUpdate) {
    // 1) explicit numeric fields on user_info
    const numericFields = [
      ['location_lat','location_lng'],
      ['lat','lng'],
      ['current_lat','current_lng'],
      ['latitude','longitude']
    ];
    for (const [latKey, lngKey] of numericFields) {
      if (shipment[latKey] !== undefined && shipment[lngKey] !== undefined && shipment[latKey] !== null && shipment[lngKey] !== null) {
        return [Number(shipment[latKey]), Number(shipment[lngKey]), 'user_info.' + latKey];
      }
      if (latestUpdate && latestUpdate[latKey] !== undefined && latestUpdate[lngKey] !== undefined && latestUpdate[latKey] !== null && latestUpdate[lngKey] !== null) {
        return [Number(latestUpdate[latKey]), Number(latestUpdate[lngKey]), 'tracking_updates.' + latKey];
      }
    }

    // 2) shipment.location may be object {lat,lng}
    if (shipment.location && typeof shipment.location === 'object' && shipment.location.lat && shipment.location.lng) {
      return [Number(shipment.location.lat), Number(shipment.location.lng), 'user_info.location object'];
    }
    if (latestUpdate && latestUpdate.location && typeof latestUpdate.location === 'object' && latestUpdate.location.lat && latestUpdate.location.lng) {
      return [Number(latestUpdate.location.lat), Number(latestUpdate.location.lng), 'tracking_updates.location object'];
    }

    // 3) location string with 'lat,lng'
    const stringCandidates = [
      shipment.location,
      shipment.location_text,
      latestUpdate ? latestUpdate.location : null
    ].filter(Boolean);

    for (const s of stringCandidates) {
      if (typeof s === 'string') {
        const parts = s.split(',').map(p => p.trim());
        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
          return [Number(parts[0]), Number(parts[1]), 'parsed lat,lng string'];
        }
      }
    }

    // 4) geocode fallback: try to geocode shipment.location or latestUpdate.location text using Nominatim
    const geocodeCandidate = shipment.location_text || shipment.location || (latestUpdate ? latestUpdate.location : null);
    if (geocodeCandidate && typeof geocodeCandidate === 'string' && geocodeCandidate.trim().length > 2) {
      try {
        const q = encodeURIComponent(geocodeCandidate);
        // Nominatim usage (client-side). This is a free service — respect usage limits.
        const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${q}`;
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!resp.ok) throw new Error('Geocode failed');
        const j = await resp.json();
        if (Array.isArray(j) && j.length > 0) {
          return [Number(j[0].lat), Number(j[0].lon), 'nominatim'];
        }
      } catch (err) {
        console.warn('Geocode error', err);
      }
    }

    // nothing found
    return [null, null, null];
  }

  /***** highlight progress step & update progress line *****/
  function highlightStep(normalizedProgress) {
    const idx = orderStatuses.indexOf(normalizedProgress);
    const activeIndex = Math.max(0, idx === -1 ? 0 : idx);

    // reset all steps
    ["stepPending","stepTransit","stepShipped","stepDelivered"].forEach(id => {
      const step = document.getElementById(id);
      if (!step) return;
      const img = step.querySelector("img");
      const p = step.querySelector("p");
      if (img) img.classList.add("opacity-50");
      if (p) {
        p.classList.remove("font-bold");
        p.classList.remove("text-sky-400");
      }
    });

    // activate up to activeIndex
    for (let i = 0; i <= activeIndex; i++) {
      const id = ["stepPending","stepTransit","stepShipped","stepDelivered"][i];
      const step = document.getElementById(id);
      if (!step) continue;
      const img = step.querySelector("img");
      const p = step.querySelector("p");
      if (img) img.classList.remove("opacity-50");
      if (p) {
        p.classList.add("font-bold");
        p.classList.add("text-sky-400");
      }
    }

    // update progressLine width
    const percent = (activeIndex / (orderStatuses.length - 1)) * 100;
    progressLine.style.width = `${percent}%`;
  }

  /***** Core: load tracking data, map, and updates *****/
  async function loadTracking() {
    // redirect back if no tracking code
    if (!trackingNo) {
      window.location.href = "tracking-form.html";
      return;
    }

    // show loading
    messageEl.dataset.loading = "true";
    messageEl.textContent = translations[currentLang].loadingShipment || "Loading shipment...";

    try {
      // Fetch shipment record
      const { data: shipment, error: shipmentError } = await supabaseClient
        .from("user_info")
        .select("*")
        .eq("tracking_no", trackingNo)
        .maybeSingle();

      if (shipmentError || !shipment) {
        // Redirect back to tracking form with an "invalid" flag and original code
        const q = new URLSearchParams({ error: "invalid", code: trackingNo });
        window.location.href = `tracking-form.html?${q.toString()}`;
        return;
      }

      // fetch updates (latest first)
      const { data: updates, error: updatesError } = await supabaseClient
        .from("tracking_updates")
        .select("*")
        .eq("shipment_id", shipment.id)
        .order("created_at", { ascending: false });

      if (updatesError) {
        console.warn('updates error', updatesError);
      }

      // assign to global variables
      fetchedShipment = shipment;
      fetchedUpdates = updates || [];

      // Render summary and timeline
      summaryEl.classList.remove("hidden");
      renderDynamicContent();

      // Map: derive coordinates & show marker
      const latestUpdate = fetchedUpdates.length ? fetchedUpdates[0] : null;
      const [lat, lng, source] = await deriveCoordinates(fetchedShipment, latestUpdate);

      if (lat && lng) {
        // update map view and marker
        await updateMapTo(lat, lng, `<strong>${escapeHtml(fetchedShipment.receiver_name || 'Package')}</strong><br>${escapeHtml(fetchedShipment.location_text || fetchedShipment.location || (latestUpdate ? latestUpdate.location : ''))}`);
      } else {
        // hide map if we can't determine a location
        mapEl.classList.add('hidden');
      }

      // show progress/timeline sections
      progressEl.classList.remove("hidden");
      if (fetchedUpdates.length) updatesEl.classList.remove("hidden");

      messageEl.textContent = "";
      delete messageEl.dataset.loading;
    } catch (err) {
      console.error(err);
      messageEl.textContent = "⚠️ Error loading shipment.";
    }
  }

  /***** Refresh helper: polls for updates and updates map/summary if changed *****/
  let refreshTimer = null;
  async function refreshTrackingIfChanged() {
    if (!fetchedShipment) return;
    try {
      const { data: shipmentFresh, error: err } = await supabaseClient
        .from("user_info")
        .select("*")
        .eq("id", fetchedShipment.id)
        .maybeSingle();
      if (err || !shipmentFresh) return;

      // quick shallow compare: location fields or status changed
      const wasChanged =
        shipmentFresh.location !== fetchedShipment.location ||
        shipmentFresh.location_text !== fetchedShipment.location_text ||
        shipmentFresh.location_lat !== fetchedShipment.location_lat ||
        shipmentFresh.location_lng !== fetchedShipment.location_lng ||
        shipmentFresh.status !== fetchedShipment.status ||
        shipmentFresh.receiver_name !== fetchedShipment.receiver_name;

      if (wasChanged) {
        // replace cached shipment and re-render
        fetchedShipment = shipmentFresh;
        // also re-fetch updates
        const { data: updatesFresh } = await supabaseClient
          .from("tracking_updates")
          .select("*")
          .eq("shipment_id", fetchedShipment.id)
          .order("created_at", { ascending: false });
        fetchedUpdates = updatesFresh || [];
        renderDynamicContent();
        // update map coordinates if available
        const latestUpdate = fetchedUpdates.length ? fetchedUpdates[0] : null;
        const [lat, lng] = await deriveCoordinates(fetchedShipment, latestUpdate);
        if (lat && lng) {
          updateMapTo(lat, lng, `<strong>${escapeHtml(fetchedShipment.receiver_name || 'Package')}</strong><br>${escapeHtml(fetchedShipment.location_text || fetchedShipment.location || (latestUpdate ? latestUpdate.location : ''))}`);
        }
      }
    } catch (err) {
      console.warn('refresh error', err);
    }
  }

  // start initial load and polling
  loadTracking().then(() => {
    // Poll every 15 seconds to pick up manual updates from dashboard
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(refreshTrackingIfChanged, 15000);
  });

  /***** apply translations to any data-key elements not yet applied *****/
  function applyTranslations(lang) {
    document.querySelectorAll('[data-key]').forEach(el => {
      const key = el.getAttribute('data-key');
      if (key && translations[lang] && translations[lang][key]) {
        el.textContent = translations[lang][key];
      }
    });
  }

  /***** small accessibility / cleanup on unload *****/
  window.addEventListener('beforeunload', () => {
    if (refreshTimer) clearInterval(refreshTimer);
  });
  </script>
</body>
</html>
