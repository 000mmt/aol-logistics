<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>배송 추적 - AOL 물류</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .progress-icon {
      width: 50px;
      height: 50px;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

  <!-- NAVBAR -->
  <header class="bg-gray-800 shadow-md fixed top-0 left-0 w-full z-50">
    <div class="container mx-auto flex items-center justify-between px-6 py-2">
      <a href="home.html" class="flex items-center space-x-2">
        <img src="images/images (2).jpeg" alt="Logo" class="h-12 w-12 object-cover rounded-full hidden sm:block">
        <div class="flex flex-col leading-tight">
          <h1 class="text-lg md:text-xl font-bold text-sky-600 italic" data-key="brand">
            AOL LOGISTICS
          </h1>
          <p class="text-xs italic text-gray-300 -mt-1 tracking-tight hidden sm:block">
            delivery service at its finest
          </p>
        </div>
      </a>
      
      <nav class="hidden md:flex space-x-6">
        <a href="#about" class="hover:text-skyblue" data-key="nav_about">회사 소개</a>
        <a href="#services" class="hover:text-skyblue" data-key="nav_services">서비스</a>
        <a href="tracking.html" class="hover:text-skyblue" data-key="nav_track">배송 추적</a>
        <a href="form.html" class="hover:text-skyblue" data-key="nav_create">배송 생성</a>
        <a href="#news" class="hover:text-skyblue" data-key="nav_news">뉴스</a>
        <a href="#contact" class="hover:text-skyblue" data-key="nav_contact">연락처</a>
        <a href="admin/login.html" class="hover:text-skyblue" data-key="nav_login">로그인</a>
      </nav>

      <div class="flex items-center">
        <button id="langToggle" class="ml-4 bg-skyblue text-white px-4 py-2 rounded">English</button>
        <button id="menuBtn" aria-expanded="false" aria-label="Open menu" class="md:hidden bg-skyblue text-white px-4 py-2 rounded ml-3" data-key="menu_text">
          메뉴
        </button>
      </div>
    </div>

    <!-- Mobile Dropdown -->
    <div id="mobileMenu" class="hidden bg-gray-800 shadow-md md:hidden">
      <nav class="flex flex-col space-y-2 px-6 py-4">
        <a href="home.html" class="hover:text-skyblue mobile-link" data-key="nav_home">홈</a>
        <a href="#about" class="hover:text-skyblue mobile-link" data-key="nav_about">회사 소개</a>
        <a href="#services" class="hover:text-skyblue mobile-link" data-key="nav_services">서비스</a>
        <a href="tracking.html" class="hover:text-skyblue mobile-link" data-key="nav_track">배송 추적</a>
        <a href="form.html" class="hover:text-skyblue mobile-link" data-key="nav_create">배송 생성</a>
        <a href="#reach" class="hover:text-skyblue mobile-link" data-key="nav_reach">글로벌 네트워크</a>
        <a href="#why" class="hover:text-skyblue mobile-link" data-key="nav_why">왜 우리인가</a>
        <a href="#industries" class="hover:text-skyblue mobile-link" data-key="nav_industries">산업 분야</a>
        <a href="#news" class="hover:text-skyblue mobile-link" data-key="nav_news">뉴스</a>
        <a href="#testimonials" class="hover:text-skyblue mobile-link" data-key="nav_testimonials">고객 후기</a>
        <a href="#contact" class="hover:text-skyblue mobile-link" data-key="nav_contact">연락처</a>
        <a href="admin/login.html" class="hover:text-skyblue mobile-link" data-key="nav_login">로그인</a>
      </nav>
    </div>
  </header>

  <!-- Container -->
  <main class="flex-1 container mx-auto px-6 py-10 mt-28">

    <!-- Shipment Summary -->
    <div id="shipmentSummary" class="bg-white shadow-lg rounded-xl p-6 mb-10 hidden">
      <h3 class="text-xl font-semibold mb-4" data-key="shipmentDetails">배송 세부 정보</h3>
      <div class="grid md:grid-cols-2 gap-4 text-sm">
        <p><strong data-key="trackingNo">운송장 번호:</strong> <span id="summaryTrackingNo"></span></p>
        <p><strong data-key="customer">고객:</strong> <span id="summaryCustomer"></span></p>
        <p><strong data-key="origin">출발지:</strong> <span id="summaryOrigin"></span></p>
        <p><strong data-key="destination">도착지:</strong> <span id="summaryDestination"></span></p>
        <p><strong data-key="status">상태:</strong> <span id="summaryStatus" class="font-semibold text-yellow-600"></span></p>
        <p><strong data-key="location">현재 위치:</strong> <span id="summaryLocation" class="font-semibold text-gray-700"></span></p>
      </div>
    </div>

    <!-- Progress Bar -->
    <div id="progressSection" class="mb-10 hidden">
      <h3 class="text-xl font-semibold mb-4" data-key="shipmentProgress">배송 진행 상황</h3>
      <div class="flex items-center justify-between relative">
        <div class="absolute top-1/2 left-0 right-0 h-1 bg-gray-200 -z-10"></div>
        <div id="stepPending" class="flex flex-col items-center">
          <img src="https://cdn-icons-png.flaticon.com/512/861/861060.png" alt="Pending" class="progress-icon opacity-50">
          <p class="mt-2 text-sm" data-key="orderPlaced">주문 접수</p>
        </div>
        <div id="stepTransit" class="flex flex-col items-center">
          <img src="https://cdn-icons-png.flaticon.com/512/263/263142.png" alt="Preparing Shipment" class="progress-icon opacity-50">
          <p class="mt-2 text-sm" data-key="preparing">준비 중</p>
        </div>
        <div id="stepShipped" class="flex flex-col items-center">
          <img src="https://cdn-icons-png.flaticon.com/512/1995/1995560.png" alt="Shipped" class="progress-icon opacity-50">
          <p class="mt-2 text-sm" data-key="shipped">배송 중</p>
        </div>
        <div id="stepDelivered" class="flex flex-col items-center">
          <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" alt="Delivered" class="progress-icon opacity-50">
          <p class="mt-2 text-sm" data-key="delivered">배송 완료</p>
        </div>
      </div>
    </div>

    <!-- Timeline -->
    <div id="updatesTimeline" class="bg-white shadow-lg rounded-xl p-6 hidden">
      <h3 class="text-xl font-semibold mb-6" data-key="trackingUpdates">배송 업데이트</h3>
      <div id="timeline" class="relative border-l border-gray-300 pl-6 space-y-6"></div>
    </div>

    <!-- Loading -->
    <div id="message" class="text-center text-gray-600 mt-10"></div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white text-center py-4">
    <p>&copy; 2025 AOL 물류. 모든 권리 보유.</p>
  </footer>

  <script>
    const SUPABASE_URL = "https://byvffsxsfehrybkyamyu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5dmZmc3hzZmVocnlia3lhbXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNDM0MjMsImV4cCI6MjA3MzgxOTQyM30.R99A5PQ2t9keXeQdglGlq35IOGRk7d3NsqPbe9Dw8uY"; // ⚠️ replace with your real key
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    const params = new URLSearchParams(window.location.search);
    const trackingNo = params.get("tracking_no");

    const summaryEl = document.getElementById("shipmentSummary");
    const updatesEl = document.getElementById("updatesTimeline");
    const progressEl = document.getElementById("progressSection");
    const timelineEl = document.getElementById("timeline");
    const messageEl = document.getElementById("message");

    // Dictionary for translations
    const translations = {
      ko: {
        home: "홈",
        shipmentDetails: "배송 세부 정보",
        trackingNo: "운송장 번호:",
        customer: "고객:",
        origin: "출발지:",
        destination: "도착지:",
        status: "상태:",
        location: "현재 위치:",
        shipmentProgress: "배송 진행 상황",
        orderPlaced: "주문 접수",
        preparing: "준비 중",
        shipped: "배송 중",
        delivered: "배송 완료",
        trackingUpdates: "배송 업데이트",
      },
      en: {
        home: "Home",
        shipmentDetails: "Shipment Details",
        trackingNo: "Tracking No:",
        customer: "Customer:",
        origin: "Origin:",
        destination: "Destination:",
        status: "Status:",
        location: "Current Location:",
        shipmentProgress: "Shipment Progress",
        orderPlaced: "Order Placed",
        preparing: "Preparing",
        shipped: "Shipped",
        delivered: "Delivered",
        trackingUpdates: "Tracking Updates",
      }
    };

    let currentLang = "ko"; // default Korean

    function switchLanguage() {
      const elements = document.querySelectorAll("[data-key]");
      elements.forEach(el => {
        const key = el.getAttribute("data-key");
        el.textContent = translations[currentLang][key];
      });
      document.getElementById("toggleLang").textContent = currentLang === "ko" ? "English" : "한국어";
    }

    document.getElementById("toggleLang").addEventListener("click", () => {
      currentLang = currentLang === "ko" ? "en" : "ko";
      switchLanguage();
    });

    // Initial translation load
    switchLanguage();

    async function loadTracking() {
      if (!trackingNo) {
        window.location.href = "tracking-form.html"; // redirect if no tracking number
        return;
      }

      messageEl.textContent = "Loading shipment...";

      // 1. Get shipment from DB
      const { data: shipment, error: shipmentError } = await supabaseClient
        .from("user_info")
        .select("*")
        .eq("tracking_no", trackingNo)
        .maybeSingle();

      if (shipmentError || !shipment) {
        window.location.href = "tracking-form.html"; // if invalid, redirect back
        return;
      }

      // 2. Get updates from DB
      const { data: updates, error: updatesError } = await supabaseClient
        .from("tracking_updates")
        .select("*")
        .eq("shipment_id", shipment.id)
        .order("created_at", { ascending: false });

      if (updatesError) {
        messageEl.textContent = "⚠️ Error loading updates.";
        return;
      }

      const latestUpdate = updates?.length > 0 ? updates[0] : null;

      // Fill summary
      summaryEl.classList.remove("hidden");
      document.getElementById("summaryTrackingNo").textContent = shipment.tracking_no;
      document.getElementById("summaryCustomer").textContent = shipment.receiver_name || "-";
      document.getElementById("summaryOrigin").textContent = shipment.origin || "-";
      document.getElementById("summaryDestination").textContent = shipment.receiver_country || "-";
      document.getElementById("summaryStatus").textContent = latestUpdate?.progress || "Order Placed";
      document.getElementById("summaryLocation").textContent = latestUpdate?.location || "Not available";

      // Progress bar
      progressEl.classList.remove("hidden");
      highlightStep(latestUpdate?.progress || "Order Placed");

      // Timeline
      if (updates?.length > 0) {
        updatesEl.classList.remove("hidden");
        timelineEl.innerHTML = updates.map(update => `
          <div class="relative">
            <div class="absolute -left-3 top-1 w-6 h-6 rounded-full bg-yellow-500 border-2 border-white"></div>
            <div class="ml-4">
              <p class="font-semibold text-yellow-600">${update.progress}</p>
              <p class="text-gray-700">${update.location || "Unknown"}</p>
              <p class="text-sm text-gray-500">${new Date(update.created_at).toLocaleString()}</p>
              ${update.note ? `<p class="mt-1 text-gray-600 italic">${update.note}</p>` : ""}
            </div>
          </div>
        `).join("");
      }

      messageEl.textContent = "";
    }

    function highlightStep(progress) {
      const steps = {
        "Order Placed": "stepPending",
        "Preparing Shipment": "stepTransit",
        "Shipped": "stepShipped",
        "Delivered": "stepDelivered"
      };

      Object.values(steps).forEach(id => {
        const step = document.getElementById(id);
        step.querySelector("img").classList.add("opacity-50");
        step.querySelector("p").classList.remove("font-bold");
      });

      if (steps[progress]) {
        const step = document.getElementById(steps[progress]);
        step.querySelector("img").classList.remove("opacity-50");
        step.querySelector("p").classList.add("font-bold");
      }
    }

    loadTracking();
  </script>
</body>
</html>
