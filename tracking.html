<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>배송 추적 - AOL 물류</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    .progress-icon { width: 50px; height: 50px; }
    #mobileMenu.mobile-menu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 300ms ease, opacity 250ms ease;
      opacity: 0;
    }
    #mobileMenu.mobile-menu.open { max-height: 420px; opacity: 1; }
    #progressLine { height: 4px; }
    .progress-step { width: 50%; }
    @media (min-width: 640px) { .progress-step { width: auto; } }
    #map { width: 100%; height: 300px; border-radius: 0.5rem; margin-bottom: 1.5rem; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

  <!-- Header/Navbar -->
  <header class="bg-gray-800 shadow-md sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center px-4 md:px-6 py-3">
      <a href="home.html" class="flex items-center space-x-3">
        <img src="images/images (2).jpeg" alt="Logo" class="h-12 w-12 object-cover rounded-full">
        <div class="flex flex-col leading-tight min-w-0">
          <h1 class="text-lg md:text-xl font-bold text-sky-400 italic truncate" data-key="brand">AOL LOGISTICS</h1>
          <p class="text-xs italic text-gray-300 -mt-1 tracking-tight truncate hidden sm:block">delivery service at its finest</p>
        </div>
      </a>
      <nav class="hidden md:flex space-x-6 text-gray-200 font-medium items-center">
        <a href="home.html" class="hover:text-sky-400" data-key="nav_home">Home</a>
        <a href="tracking-form.html" class="hover:text-sky-400" data-key="nav_tracking">Tracking</a>
      </nav>
      <div class="flex items-center space-x-3">
        <button id="toggleLang" aria-pressed="false" class="px-3 py-1 text-sm bg-sky-500 text-white rounded-md hover:bg-sky-600">English</button>
        <button id="menuBtn" class="md:hidden focus:outline-none" aria-controls="mobileMenu" aria-expanded="false">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
    <div id="mobileMenu" class="mobile-menu md:hidden absolute top-full left-0 right-0 bg-gray-700 z-40">
      <nav class="flex flex-col space-y-2 p-4">
        <a href="home.html" class="block text-gray-200 hover:text-sky-400" data-key="nav_home_mobile">Home</a>
        <a href="tracking-form.html" class="block text-gray-200 hover:text-sky-400" data-key="nav_tracking_mobile">Tracking</a>
      </nav>
    </div>
  </header>

  <!-- Container -->
  <main class="flex-1 container mx-auto px-4 md:px-6 py-8 md:py-10">

    <!-- Shipment Summary -->
    <div id="shipmentSummary" class="bg-gray-800 shadow-lg rounded-xl p-6 mb-8 hidden">
      <h3 class="text-xl font-semibold mb-4 text-sky-400" data-key="shipmentDetails">배송 세부 정보</h3>
      <div class="grid md:grid-cols-2 gap-4 text-sm">
        <p><strong data-key="trackingNo">운송장 번호:</strong> <span id="summaryTrackingNo"></span></p>
        <p><strong data-key="customer">고객:</strong> <span id="summaryCustomer"></span></p>
        <p><strong data-key="origin">출발지:</strong> <span id="summaryOrigin"></span></p>
        <p><strong data-key="destination">도착지:</strong> <span id="summaryDestination"></span></p>
        <p><strong data-key="status">상태:</strong> <span id="summaryStatus" class="font-semibold text-sky-400"></span></p>
        <p><strong data-key="location">현재 위치:</strong> <span id="summaryLocation" class="font-semibold text-gray-300"></span></p>
      </div>
      <!-- Map -->
      <div id="map"></div>
    </div>

   <!-- Progress Bar -->
   <div id="progressSection" class="mb-8 hidden">
     <h3 class="text-xl font-semibold mb-4 text-sky-400" data-key="shipmentProgress">배송 진행 상황</h3>
     <div class="relative flex items-center justify-between">
       <div class="absolute top-1/2 inset-x-0 mx-auto h-1 bg-gray-600 -z-10 rounded w-full max-w-[90%]"></div>
       <div id="progressLine" class="absolute top-1/2 left-0 h-1 bg-sky-500 -z-10 rounded transition-all duration-500" style="width:0%;"></div>

       <div id="stepPending" class="flex flex-col items-center relative z-10 w-1/4">
         <img src="https://cdn-icons-png.flaticon.com/512/861/861060.png" alt="Pending" class="progress-icon opacity-50">
         <p class="mt-2 text-sm" data-key="orderPlaced">주문 접수</p>
       </div>
       <div id="stepTransit" class="flex flex-col items-center relative z-10 w-1/4">
         <img src="https://cdn-icons-png.flaticon.com/512/263/263142.png" alt="Preparing Shipment" class="progress-icon opacity-50">
         <p class="mt-2 text-sm" data-key="preparing">준비 중</p>
       </div>
       <div id="stepShipped" class="flex flex-col items-center relative z-10 w-1/4">
         <img src="https://cdn-icons-png.flaticon.com/512/1995/1995560.png" alt="Shipped" class="progress-icon opacity-50">
         <p class="mt-2 text-sm" data-key="shipped">배송 중</p>
       </div>
       <div id="stepDelivered" class="flex flex-col items-center relative z-10 w-1/4">
         <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" alt="Delivered" class="progress-icon opacity-50">
         <p class="mt-2 text-sm" data-key="delivered">배송 완료</p>
       </div>
     </div>
   </div>

    <!-- Timeline -->
    <div id="updatesTimeline" class="bg-gray-800 shadow-lg rounded-xl p-6 hidden">
      <h3 class="text-xl font-semibold mb-6 text-sky-400" data-key="trackingUpdates">배송 업데이트</h3>
      <div id="timeline" class="relative border-l border-gray-600 pl-6 space-y-6"></div>
    </div>

    <!-- Loading / Message -->
    <div id="message" class="text-center text-gray-400 mt-6"></div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white text-center py-4">
    <p>&copy; 2025 AOL 물류. 모든 권리 보유.</p>
  </footer>

  <script>
  /***** CONFIG *****/
  const SUPABASE_URL = "https://byvffsxsfehrybkyamyu.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5dmZmc3hzZmVocnlia3lhbXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNDM0MjMsImV4cCI6MjA3MzgxOTQyM30.R99A5PQ2t9keXeQdglGlq35IOGRk7d3NsqPbe9Dw8uY";

  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

  const menuBtn = document.getElementById("menuBtn");
  const mobileMenu = document.getElementById("mobileMenu");
  const toggleLangBtn = document.getElementById("toggleLang");
  const params = new URLSearchParams(window.location.search);
  const trackingNo = params.get("tracking_no");
  const summaryEl = document.getElementById("shipmentSummary");
  const updatesEl = document.getElementById("updatesTimeline");
  const progressEl = document.getElementById("progressSection");
  const timelineEl = document.getElementById("timeline");
  const messageEl = document.getElementById("message");
  const progressLine = document.getElementById("progressLine");
  let map, marker;

  /***** Translations *****/
  const translations = {
    ko: {
      brand:"AOL LOGISTICS", nav_home:"홈", nav_tracking:"배송 추적", nav_home_mobile:"홈", nav_tracking_mobile:"배송 추적",
      shipmentDetails:"배송 세부 정보", trackingNo:"운송장 번호:", customer:"고객:", origin:"출발지:", destination:"도착지:",
      status:"상태:", location:"현재 위치:", shipmentProgress:"배송 진행 상황", orderPlaced:"주문 접수", preparing:"준비 중",
      shipped:"배송 중", delivered:"배송 완료", trackingUpdates:"배송 업데이트", loadingShipment:"배송 정보를 불러오는 중...",
      invalidCodeMessage:"유효하지 않은 운송장 코드."
    },
    en: {
      brand:"AOL LOGISTICS", nav_home:"Home", nav_tracking:"Track Shipment", nav_home_mobile:"Home", nav_tracking_mobile:"Track Shipment",
      shipmentDetails:"Shipment Details", trackingNo:"Tracking No:", customer:"Customer:", origin:"Origin:", destination:"Destination:",
      status:"Status:", location:"Current Location:", shipmentProgress:"Shipment Progress", orderPlaced:"Order Placed",
      preparing:"Preparing", shipped:"Shipped", delivered:"Delivered", trackingUpdates:"Tracking Updates",
      loadingShipment:"Loading shipment...", invalidCodeMessage:"Invalid tracking code."
    }
  };

  /***** Mobile menu toggle *****/
  let menuOpen = false;
  menuBtn.addEventListener('click',()=>{ menuOpen=!menuOpen; mobileMenu.classList.toggle('open',menuOpen); mobileMenu.classList.remove('hidden'); menuBtn.setAttribute('aria-expanded',String(menuOpen)); });

  /***** Language toggle *****/
  let currentLang = localStorage.getItem('site_lang') || 'ko';
  toggleLangBtn.addEventListener('click',()=>{ const next=currentLang==='ko'?'en':'ko'; setLanguage(next); });
  function setLanguage(lang){
    currentLang=lang; localStorage.setItem('site_lang',lang);
    document.querySelectorAll('[data-key]').forEach(el=>{ const k=el.getAttribute('data-key'); if(k && translations[lang][k]) el.textContent=translations[lang][k]; });
    toggleLangBtn.textContent=(lang==='ko')?'English':'한국어';
  }

  /***** Load tracking and map *****/
  async function loadTracking(){
    if(!trackingNo){ window.location.href="tracking-form.html"; return; }
    messageEl.textContent=translations[currentLang].loadingShipment;

    try{
      const { data: shipment } = await supabaseClient.from("user_info").select("*").eq("tracking_no",trackingNo).maybeSingle();
      if(!shipment){ window.location.href=`tracking-form.html?error=invalid&code=${trackingNo}`; return; }

      summaryEl.classList.remove("hidden");
      document.getElementById("summaryTrackingNo").textContent=shipment.tracking_no;
      document.getElementById("summaryCustomer").textContent=shipment.receiver_name||"-";
      document.getElementById("summaryOrigin").textContent=shipment.origin||"-";
      document.getElementById("summaryDestination").textContent=shipment.receiver_country||"-";
      document.getElementById("summaryStatus").textContent=shipment.status||"-";
      document.getElementById("summaryLocation").textContent=shipment.current_location||"-";

      progressEl.classList.remove("hidden");

      // Leaflet map
      map=L.map('map').setView([6.5244,3.3792],6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

      if(shipment.current_location){
        const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(shipment.current_location)}`);
        const geoData=await res.json();
        if(geoData.length){
          const lat=parseFloat(geoData[0].lat), lon=parseFloat(geoData[0].lon);
          map.setView([lat,lon],13);
          marker=L.marker([lat,lon]).addTo(map).bindPopup(`${translations[currentLang].location} : ${shipment.current_location}`).openPopup();
        }
      }

      messageEl.textContent="";
    }catch(err){ console.error(err); messageEl.textContent="⚠️ Error loading shipment."; }
  }

  setLanguage(currentLang);
  loadTracking();
  </script>
</body>
</html>
