<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>배송 추적 - AOL 물류</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    /* icons size */
    .progress-icon {
      width: 50px;
      height: 50px;
    }

    /* mobile menu collapse animation (use max-height to animate) */
    #mobileMenu.mobile-menu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 300ms ease, opacity 250ms ease;
      opacity: 0;
    }
    #mobileMenu.mobile-menu.open {
      max-height: 420px; /* enough to show links */
      opacity: 1;
    }

    /* ensure progress line sits above base line visually */
    #progressLine {
      height: 4px;
    }

    /* responsive tweaks to make progress steps wrap on small screens */
    .progress-step {
      width: 50%;
    }
    @media (min-width: 640px) {
      .progress-step {
        width: auto;
      }
    }

    /* Map styling and spacing to prevent it from hugging the details */
    #map {
      height: 420px;
      width: 100%;
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 0 6px 20px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    }

    /* small helper for timeline items */
    .timeline-item { padding-left: 0.75rem; border-left-width: 2px; border-left-color: rgba(14,165,233,0.85); }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

  <!-- Header/Navbar -->
  <header class="bg-gray-800 shadow-md sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center px-4 md:px-6 py-3">
      <!-- Logo -->
      <a href="home.html" class="flex items-center space-x-3">
        <img src="images/images (2).jpeg" alt="Logo" class="h-12 w-12 object-cover rounded-full">
        <div class="flex flex-col leading-tight min-w-0">
          <h1 class="text-lg md:text-xl font-bold text-sky-400 italic truncate" data-key="brand">
            AOL LOGISTICS
          </h1>
          <p class="text-xs italic text-gray-300 -mt-1 tracking-tight truncate hidden sm:block">
            delivery service at its finest
          </p>
        </div>
      </a>

      <!-- Desktop Nav -->
      <nav class="hidden md:flex space-x-6 text-gray-200 font-medium items-center">
        <a href="home.html" class="hover:text-sky-400" data-key="nav_home">Home</a>
        <a href="tracking-form.html" class="hover:text-sky-400" data-key="nav_tracking">Tracking</a>
      </nav>

      <!-- Right Side -->
      <div class="flex items-center space-x-3">
        <button id="toggleLang" aria-pressed="false" class="px-3 py-1 text-sm bg-sky-500 text-white rounded-md hover:bg-sky-600">
          English
        </button>

        <!-- mobile menu button -->
        <button id="menuBtn" class="md:hidden focus:outline-none" aria-controls="mobileMenu" aria-expanded="false">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor"
               viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round"
                  stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu (animated overlay under header) -->
    <div id="mobileMenu" class="mobile-menu md:hidden absolute top-full left-0 right-0 bg-gray-700 z-40">
      <nav class="flex flex-col space-y-2 p-4">
        <a href="home.html" class="block text-gray-200 hover:text-sky-400" data-key="nav_home_mobile">Home</a>
        <a href="tracking-form.html" class="block text-gray-200 hover:text-sky-400" data-key="nav_tracking_mobile">Tracking</a>
      </nav>
    </div>
  </header>

  <!-- Container -->
  <main class="flex-1 container mx-auto px-4 md:px-6 py-8 md:py-10">

    <!-- Shipment Summary -->
    <div id="shipmentSummary" class="bg-gray-800 shadow-lg rounded-xl p-6 mb-4 hidden">
      <h3 class="text-xl font-semibold mb-4 text-sky-400" data-key="shipmentDetails">배송 세부 정보</h3>
      <div class="grid md:grid-cols-2 gap-4 text-sm">
        <p><strong data-key="trackingNo">운송장 번호:</strong> <span id="summaryTrackingNo"></span></p>
        <p><strong data-key="customer">고객:</strong> <span id="summaryCustomer"></span></p>
        <p><strong data-key="origin">출발지:</strong> <span id="summaryOrigin"></span></p>
        <p><strong data-key="destination">도착지:</strong> <span id="summaryDestination"></span></p>
        <p><strong data-key="status">상태:</strong> <span id="summaryStatus" class="font-semibold text-sky-400"></span></p>
        <p><strong data-key="location">현재 위치:</strong> <span id="summaryLocation" class="font-semibold text-gray-300"></span></p>
      </div>
    </div>

    <!-- Map: placed after shipment details and before progress -->
    <div id="map" class="hidden" aria-hidden="true"></div>

   <!-- Progress Bar -->
   <div id="progressSection" class="mb-8 hidden">
     <h3 class="text-xl font-semibold mb-4 text-sky-400" data-key="shipmentProgress">배송 진행 상황</h3>

     <div class="relative flex items-center justify-between">
       <!-- Base line (gray) -->
       <div class="absolute top-1/2 inset-x-0 mx-auto h-1 bg-gray-600 -z-10 rounded w-full max-w-[90%]"></div>

       <!-- Load (sky-blue) line -->
       <div id="progressLine" class="absolute top-1/2 left-0 h-1 bg-sky-500 -z-10 rounded transition-all duration-500" style="width:0%;"></div>

       <!-- Steps -->
       <div id="stepPending" class="flex flex-col items-center relative z-10 w-1/4">
         <img src="https://cdn-icons-png.flaticon.com/512/861/861060.png" alt="Pending" class="progress-icon opacity-50">
         <p class="mt-2 text-sm" data-key="orderPlaced">주문 접수</p>
       </div>

       <div id="stepTransit" class="flex flex-col items-center relative z-10 w-1/4">
         <img src="https://cdn-icons-png.flaticon.com/512/263/263142.png" alt="Preparing Shipment" class="progress-icon opacity-50">
         <p class="mt-2 text-sm" data-key="preparing">준비 중</p>
       </div>

       <div id="stepShipped" class="flex flex-col items-center relative z-10 w-1/4">
         <img src="https://cdn-icons-png.flaticon.com/512/1995/1995560.png" alt="Shipped" class="progress-icon opacity-50">
         <p class="mt-2 text-sm" data-key="shipped">배송 중</p>
       </div>

       <div id="stepDelivered" class="flex flex-col items-center relative z-10 w-1/4">
         <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" alt="Delivered" class="progress-icon opacity-50">
         <p class="mt-2 text-sm" data-key="delivered">배송 완료</p>
       </div>
     </div>
   </div>

    <!-- Timeline -->
    <div id="updatesTimeline" class="bg-gray-800 shadow-lg rounded-xl p-6 hidden">
      <h3 class="text-xl font-semibold mb-6 text-sky-400" data-key="trackingUpdates">배송 업데이트</h3>
      <div id="timeline" class="relative border-l border-gray-600 pl-6 space-y-6"></div>
    </div>

    <!-- Loading / Message -->
    <div id="message" class="text-center text-gray-400 mt-6"></div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white text-center py-4">
    <p>&copy; 2025 AOL 물류. 모든 권리 보유.</p>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
     // Supabase configuration
const SUPABASE_URL = "https://ozoiqsoabqjcdyjsvrmb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96b2lxc29hYnFqY2R5anN2cm1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM3NDM1MjEsImV4cCI6MjA0OTMxOTUyMX0.wGHnL7MsoNUvh8mrlPI2Z7Za2hlMYvmhxlaPyd07_9U";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Escape HTML to prevent XSS
function escapeHtml(str = "") {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

// Handle mobile menu toggle
const menuToggle = document.getElementById("menu-toggle");
const mobileMenu = document.getElementById("mobile-menu");
let menuOpen = false;

if (menuToggle && mobileMenu) {
  menuToggle.addEventListener("click", () => {
    menuOpen = !menuOpen;
    if (menuOpen) {
      mobileMenu.classList.remove("hidden");
      setTimeout(() => mobileMenu.classList.add("open"), 10);
    } else {
      mobileMenu.classList.remove("open");
      setTimeout(() => {
        if (!menuOpen) mobileMenu.classList.add("hidden");
      }, 300);
    }
  });
}

// Language support
const translations = {
  en: {
    tracking_title: "Shipment Tracking",
    tracking_input_placeholder: "Enter your tracking number",
    track_button: "Track",
    error_invalid: "Invalid tracking number",
    current_status: "Current Status",
    tracking_history: "Tracking History",
    delivered: "Delivered",
    in_transit: "In Transit",
    preparing: "Preparing Shipment",
    order_placed: "Order Placed",
    map_title: "Delivery Location"
  },
  ko: {
    tracking_title: "배송 추적",
    tracking_input_placeholder: "송장 번호를 입력하세요",
    track_button: "추적",
    error_invalid: "잘못된 송장 번호입니다",
    current_status: "현재 상태",
    tracking_history: "배송 내역",
    delivered: "배송 완료",
    in_transit: "배송 중",
    preparing: "배송 준비중",
    order_placed: "주문 완료",
    map_title: "배송 위치"
  }
};

let currentLang = "en";

function applyTranslations(lang) {
  currentLang = lang;
  document.querySelectorAll("[data-key]").forEach(el => {
    const key = el.getAttribute("data-key");
    if (translations[lang][key]) {
      if (el.tagName === "INPUT") {
        el.placeholder = translations[lang][key];
      } else {
        el.textContent = translations[lang][key];
      }
    }
  });
}

document.querySelectorAll("[data-lang]").forEach(btn => {
  btn.addEventListener("click", () => applyTranslations(btn.getAttribute("data-lang")));
});

// Tracking logic
const form = document.getElementById("tracking-form");
const input = document.getElementById("tracking-number");
const result = document.getElementById("tracking-result");

let map, marker;
function initMap(lat, lng) {
  const mapEl = document.getElementById("map");
  if (!lat || !lng) {
    if (mapEl) mapEl.classList.add("hidden");
    return;
  }
  if (!map) {
    map = L.map("map").setView([lat, lng], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(map);
    marker = L.marker([lat, lng]).addTo(map);
  } else {
    map.setView([lat, lng], 13);
    marker.setLatLng([lat, lng]);
  }
  if (mapEl) mapEl.classList.remove("hidden");
}

const statusMapping = {
  order_placed: "Order Placed",
  preparing: "Preparing Shipment",
  in_transit: "In Transit",
  delivered: "Delivered"
};

async function fetchTracking(code) {
  result.innerHTML =
    `<div class="text-center py-4">Loading...</div>`;
  try {
    const { data: shipment, error } = await supabaseClient
      .from("shipments")
      .select("*")
      .eq("tracking_code", code)
      .maybeSingle();
    if (error || !shipment) {
      result.innerHTML =
        `<div class="text-red-500 text-center">${translations[currentLang].error_invalid}</div>`;
      return;
    }

    const { data: updates, error: updatesError } = await supabaseClient
      .from("tracking_updates")
      .select("*")
      .eq("shipment_id", shipment.id)
      .order("created_at", { ascending: false });
    if (updatesError) throw updatesError;

    let currentStep = Object.keys(statusMapping).indexOf(shipment.status);
    let progressSteps = Object.keys(statusMapping)
      .map((key, i) =>
        `<div class="progress-step ${i <= currentStep ? "active" : ""} w-1/4">${translations[currentLang][key]}</div>`
      )
      .join("");

    let historyHtml = updates
      .map(
        update => `
      <div class="bg-gray-50 p-3 rounded">
        <div class="font-medium">${escapeHtml(update.status)}</div>
        <div class="text-sm text-gray-600">${escapeHtml(update.location || "")}</div>
        <div class="text-xs text-gray-400">${new Date(update.created_at).toLocaleString(currentLang === "ko" ? "ko-KR" : "en-US")}</div>
        <div class="text-sm">${escapeHtml(update.note || "")}</div>
      </div>`
      )
      .join("");

    result.innerHTML = `
      <div class="space-y-4">
        <div class="tracking-progress flex items-center">${progressSteps}</div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-bold mb-2">${translations[currentLang].current_status}: ${translations[currentLang][shipment.status]}</h3>
          <p>Tracking Code: ${escapeHtml(shipment.tracking_code)}</p>
        </div>
        <div>
          <h3 class="font-bold mb-2">${translations[currentLang].tracking_history}</h3>
          <div class="space-y-2">${historyHtml}</div>
        </div>
        <div>
          <h3 class="font-bold mb-2">${translations[currentLang].map_title}</h3>
          <div id="map" class="h-64 rounded shadow"></div>
        </div>
      </div>
    `;

    if (updates.length && updates[0].location) {
      let coords = updates[0].location;
      if (typeof coords === "string" && coords.includes(",")) {
        let [lat, lng] = coords.split(",").map(Number);
        initMap(lat, lng);
      } else if (typeof coords === "object" && coords.lat && coords.lng) {
        initMap(coords.lat, coords.lng);
      } else {
        try {
          const res = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(coords)}`
          );
          const data = await res.json();
          if (data.length) initMap(parseFloat(data[0].lat), parseFloat(data[0].lon));
          else initMap(null, null);
        } catch {
          initMap(null, null);
        }
      }
    } else {
      initMap(null, null);
    }
  } catch (err) {
    console.error(err);
    result.innerHTML =
      `<div class="text-red-500 text-center">Error loading tracking</div>`;
  }
}

form.addEventListener("submit", e => {
  e.preventDefault();
  fetchTracking(input.value.trim());
});

// Auto refresh
let refreshInterval;
function startAutoRefresh(code) {
  if (refreshInterval) clearInterval(refreshInterval);
  refreshInterval = setInterval(() => fetchTracking(code), 15000);
}

form.addEventListener("submit", e => {
  e.preventDefault();
  let code = input.value.trim();
  if (!code) return;
  fetchTracking(code);
  startAutoRefresh(code);
});

// Accessibility: close menu with Esc
document.addEventListener("keydown", e => {
  if (e.key === "Escape" && menuOpen) {
    menuToggle.click();
  }
});

/***** small accessibility / cleanup on unload *****/
window.addEventListener("beforeunload", () => {
  if (refreshInterval) clearInterval(refreshInterval);
});

// Initialize default language
applyTranslations(currentLang);

  </script>
</body>
</html>
