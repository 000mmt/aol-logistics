<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Track Shipment - AOL Logistics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .progress-icon {
      width: 50px;
      height: 50px;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow-md p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-yellow-600">AOL Logistics</h1>
    <a href="home.html" class="text-gray-600 hover:text-yellow-600">Home</a>
  </header>

  <!-- Container -->
  <main class="flex-1 container mx-auto px-6 py-10">
    <h2 class="text-3xl font-bold mb-6 text-center">Track Your Shipment</h2>



    <!-- Tracking Form -->
<div id="trackingForm" class="bg-white shadow-lg rounded-xl p-6 mb-10">
  <form id="trackForm" class="flex flex-col md:flex-row items-center gap-4">
    <input 
      type="text" 
      id="trackingInput" 
      name="tracking_no" 
      placeholder="Enter Tracking Number" 
      class="flex-1 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-yellow-500" 
      required
    />
    <button 
      type="submit" 
      class="bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 transition"
    >
      Track
    </button>
  </form>
</div>



    

    <!-- Shipment Summary -->
    <div id="shipmentSummary" class="bg-white shadow-lg rounded-xl p-6 mb-10 hidden">
      <h3 class="text-xl font-semibold mb-4">Shipment Details</h3>
      <div class="grid md:grid-cols-2 gap-4 text-sm">
        <p><strong>Tracking No:</strong> <span id="summaryTrackingNo"></span></p>
        <p><strong>Customer:</strong> <span id="summaryCustomer"></span></p>
        <p><strong>Origin:</strong> <span id="summaryOrigin"></span></p>
        <p><strong>Destination:</strong> <span id="summaryDestination"></span></p>
        <p><strong>Status:</strong> <span id="summaryStatus" class="font-semibold text-yellow-600"></span></p>
        <p><strong>Current Location:</strong> <span id="summaryLocation" class="font-semibold text-gray-700"></span></p>
      </div>
    </div>

    <!-- Progress Bar -->
    <div id="progressSection" class="mb-10 hidden">
      <h3 class="text-xl font-semibold mb-4">Shipment Progress</h3>
      <div class="flex items-center justify-between relative">
        <div class="absolute top-1/2 left-0 right-0 h-1 bg-gray-200 -z-10"></div>
        <div id="stepPending" class="flex flex-col items-center">
          <img src="images/pending.png" alt="Pending" class="progress-icon opacity-50">
          <p class="mt-2 text-sm">Order Placed</p>
        </div>
        <div id="stepTransit" class="flex flex-col items-center">
          <img src="images/preparing.png" alt="Preparing Shipment" class="progress-icon opacity-50">
          <p class="mt-2 text-sm">Preparing Shipment</p>
        </div>
        <div id="stepShipped" class="flex flex-col items-center">
          <img src="images/shipped.png" alt="Shipped" class="progress-icon opacity-50">
          <p class="mt-2 text-sm">Shipped</p>
        </div>
        <div id="stepDelivered" class="flex flex-col items-center">
          <img src="images/delivered.png" alt="Delivered" class="progress-icon opacity-50">
          <p class="mt-2 text-sm">Delivered</p>
        </div>
      </div>
    </div>

    <!-- Timeline -->
    <div id="updatesTimeline" class="bg-white shadow-lg rounded-xl p-6 hidden">
      <h3 class="text-xl font-semibold mb-6">Tracking Updates</h3>
      <div id="timeline" class="relative border-l border-gray-300 pl-6 space-y-6"></div>
    </div>

    <!-- Error / Loading -->
    <div id="message" class="text-center text-gray-600 mt-10"></div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white text-center py-4">
    <p>&copy; 2025 AOL Logistics. All rights reserved.</p>
  </footer>

  <script>
  const SUPABASE_URL = "https://byvffsxsfehrybkyamyu.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5dmZmc3hzZmVocnlia3lhbXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNDM0MjMsImV4cCI6MjA3MzgxOTQyM30.R99A5PQ2t9keXeQdglGlq35IOGRk7d3NsqPbe9Dw8uY"; 
  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

  const params = new URLSearchParams(window.location.search);
  const trackingNo = params.get("tracking_no");

  const formEl = document.getElementById("trackingForm");
  const inputEl = document.getElementById("trackingInput");
  const summaryEl = document.getElementById("shipmentSummary");
  const updatesEl = document.getElementById("updatesTimeline");
  const progressEl = document.getElementById("progressSection");
  const timelineEl = document.getElementById("timeline");
  const messageEl = document.getElementById("message");

  // Handle form submission
  document.getElementById("trackForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const enteredCode = inputEl.value.trim();
    if (enteredCode) {
      window.location.href = `tracking.html?tracking_no=${enteredCode}`;
    }
  });

  async function loadTracking() {
    if (!trackingNo) {
      // No tracking code in URL → just show form
      formEl.classList.remove("hidden");
      messageEl.textContent = "";
      return;
    }

    // Pre-fill input with current tracking number
    inputEl.value = trackingNo;

    messageEl.textContent = "Loading shipment...";

    // 1. Get shipment
    const { data: shipment, error: shipmentError } = await supabaseClient
      .from("user_info")
      .select("*")
      .eq("tracking_no", trackingNo)
      .limit(1)
      .maybeSingle();

    if (shipmentError || !shipment) {
      formEl.classList.remove("hidden");
      messageEl.textContent = "❌ Tracking number not found. Please try again.";
      return;
    }

    // Success → hide form
    formEl.classList.add("hidden");

    // 2. Get updates
    const { data: updates, error: updatesError } = await supabaseClient
      .from("tracking_updates")
      .select("*")
      .eq("shipment_id", shipment.id)
      .order("created_at", { ascending: false });

    if (updatesError) {
      messageEl.textContent = "⚠️ Error loading updates.";
      return;
    }

    // Latest update
    const latestUpdate = updates && updates.length > 0 ? updates[0] : null;

    // 3. Fill summary
    summaryEl.classList.remove("hidden");
    document.getElementById("summaryTrackingNo").textContent = shipment.tracking_no;
    document.getElementById("summaryCustomer").textContent = shipment.customer_name || "-";
    document.getElementById("summaryOrigin").textContent = shipment.origin || "-";
    document.getElementById("summaryDestination").textContent = shipment.destination || "-";
    document.getElementById("summaryStatus").textContent = latestUpdate?.progress || "Order Placed";
    document.getElementById("summaryLocation").textContent = latestUpdate?.location || "Not available";

    // 4. Progress bar
    progressEl.classList.remove("hidden");
    highlightStep(latestUpdate?.progress || "Order Placed");

    // 5. Timeline
    if (!updates || updates.length === 0) {
      messageEl.textContent = "No updates available yet.";
      return;
    }

    messageEl.textContent = "";
    updatesEl.classList.remove("hidden");

    timelineEl.innerHTML = updates.map(update => `
      <div class="relative">
        <div class="absolute -left-3 top-1 w-6 h-6 rounded-full bg-yellow-500 border-2 border-white"></div>
        <div class="ml-4">
          <p class="font-semibold text-yellow-600">${update.progress}</p>
          <p class="text-gray-700">${update.location || "Unknown"}</p>
          <p class="text-sm text-gray-500">${new Date(update.created_at).toLocaleString()}</p>
          ${update.note ? `<p class="mt-1 text-gray-600 italic">${update.note}</p>` : ""}
        </div>
      </div>
    `).join("");
  }

  function highlightStep(progress) {
    const steps = {
      "Order Placed": "stepPending",
      "Preparing Shipment": "stepTransit",
      "Shipped": "stepShipped",
      "Delivered": "stepDelivered"
    };

    Object.values(steps).forEach(id => {
      const step = document.getElementById(id);
      step.querySelector("img").classList.add("opacity-50");
      step.querySelector("p").classList.remove("font-bold");
    });

    if (steps[progress]) {
      const step = document.getElementById(steps[progress]);
      step.querySelector("img").classList.remove("opacity-50");
      step.querySelector("p").classList.add("font-bold");
    }
  }

  loadTracking();
</script>

</body>
</html>
